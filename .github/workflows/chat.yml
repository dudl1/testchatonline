name: Chat Sync

on:
  # Триггер при создании issue с меткой chat-message
  issues:
    types: [opened, edited]
  
  # Можно запускать по расписанию для очистки
  schedule:
    - cron: '0 0 * * *'  # Каждый день в полночь
  
  # Ручной запуск
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - cleanup
          - backup

jobs:
  process-message:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'chat-message')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Process new message
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            try {
              const message = JSON.parse(issue.body);
              console.log('New message from:', message.author);
              console.log('Message:', message.text);
              
              // Можно добавить уведомления, модерацию и т.д.
              
              // Добавляем реакцию для подтверждения
              await github.rest.reactions.createForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                content: 'rocket'
              });
              
            } catch (error) {
              console.error('Error processing message:', error);
            }

  cleanup-old-messages:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'cleanup')
    runs-on: ubuntu-latest
    
    steps:
      - name: Cleanup old messages
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Получаем все chat-message issues старше 7 дней
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: 'chat-message',
              state: 'open',
              per_page: 100
            });
            
            let closedCount = 0;
            
            for (const issue of issues.data) {
              const createdAt = new Date(issue.created_at);
              
              if (createdAt < sevenDaysAgo) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                closedCount++;
              }
            }
            
            console.log(`Closed ${closedCount} old messages`);

  backup-messages:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'backup'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Backup messages to file
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            
            // Получаем все сообщения
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: 'chat-message',
              state: 'all',
              per_page: 100
            });
            
            const messages = [];
            
            for (const issue of issues.data) {
              try {
                const message = JSON.parse(issue.body);
                messages.push({
                  ...message,
                  issue_number: issue.number,
                  issue_state: issue.state
                });
              } catch (e) {
                console.error('Error parsing issue:', issue.number);
              }
            }
            
            // Сортируем по времени
            messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Сохраняем в файл
            fs.writeFileSync('backup/messages.json', JSON.stringify(messages, null, 2));
            
            console.log(`Backed up ${messages.length} messages`);
      
      - name: Commit backup
        run: |
          mkdir -p backup
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add backup/
          git commit -m "Backup messages $(date +%Y-%m-%d)" || echo "No changes"
          git push

  sync-to-gist:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'sync'
    runs-on: ubuntu-latest
    
    steps:
      - name: Sync messages to Gist
        uses: actions/github-script@v7
        env:
          GIST_ID: ${{ secrets.CHAT_GIST_ID }}
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const gistId = process.env.GIST_ID;
            
            if (!gistId) {
              console.log('No GIST_ID configured');
              return;
            }
            
            // Получаем последние сообщения
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: 'chat-message',
              state: 'open',
              per_page: 50,
              sort: 'created',
              direction: 'desc'
            });
            
            const messages = [];
            
            for (const issue of issues.data) {
              try {
                messages.push(JSON.parse(issue.body));
              } catch (e) {}
            }
            
            messages.reverse();
            
            // Обновляем Gist
            await github.rest.gists.update({
              gist_id: gistId,
              files: {
                'messages.json': {
                  content: JSON.stringify(messages, null, 2)
                }
              }
            });
            
            console.log('Synced', messages.length, 'messages to Gist');
